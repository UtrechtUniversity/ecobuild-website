---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import PublicationItem from "../components/PublicationItem.astro";
import BookItem from "../components/BookItem.astro";
import PresentationCard from "../components/PresentationCard.astro";
import {
  Book,
  FileCode,
  ScrollText,
  Presentation,
  BookOpen,
  CheckCircle,
  Clock,
  Newspaper,
  FileInput,
  ArrowRight,
} from "lucide-react";

// Fetch Collections
const papers = (await getCollection("publications"))
  .filter((p) => p.data.type === "paper" || p.data.type === "journal")
  .sort((a, b) => b.data.year - a.data.year);

const newspapers = (await getCollection("publications"))
  .filter((p) => p.data.type === "newspaper")
  .sort((a, b) => b.data.year - a.data.year);
const books = (await getCollection("books")).sort(
  (a, b) => b.data.year - a.data.year,
);

const softwares = (await getCollection("softwares")).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

const patents = (await getCollection("patents")).sort(
  (a, b) => b.data.date.valueOf() - a.data.date.valueOf(),
);

const allPresentations = (await getCollection("presentations")).sort(
  (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
);

const presentations = allPresentations.filter(
  (p) => p.data.style === "presentation" || p.data.style === "conference",
);

const sections = [
  {
    id: "papers",
    title: "Published Papers",
    key: "achievements.papers",
    icon: BookOpen,
    count: papers.length,
  },
  {
    id: "newspapers",
    title: "Newspaper Articles",
    key: "achievements.newspapers",
    icon: Newspaper,
    count: newspapers.length,
  },
  //Software Copyrights section removed until further notice
  // {
  //   id: "softwares",
  //   title: "Software Copyrights",
  //   key: "achievements.softwares",
  //   icon: FileCode,
  //   count: softwares.length,
  // },
  {
    id: "presentations",
    title: "Conferences & Presentations",
    key: "achievements.presentations",
    icon: Presentation,
    count: allPresentations.length,
  },
];
---

<Layout title="Publications">
  <div class="max-w-7xl mx-auto px-4 py-12 sm:py-20">
    <div class="max-w-3xl mx-auto text-center mb-16">
      <h1 class="text-4xl font-bold text-gray-900 mb-4">Publications</h1>
      <p class="text-lg text-gray-600">
        A collection of our academic publications, newspapers articles, and
        presentations.
      </p>
    </div>

    <!-- Navigation Pills -->
    <div
      class="flex flex-wrap justify-center gap-4 mb-16 relative md:sticky md:top-20 z-30 bg-white/80 backdrop-blur p-4 rounded-2xl border border-gray-100 shadow-sm"
    >
      {
        sections.map((section) => (
          <a
            href={`#${section.id}`}
            class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-gray-50 text-gray-600 hover:bg-blue-50 hover:text-blue-600 transition-colors text-sm font-medium"
          >
            <section.icon className="w-4 h-4" />
            <span data-i18n-key={section.key}>{section.title}</span>
            <span class="bg-white px-2 py-0.5 rounded-full text-xs text-gray-400 shadow-sm">
              {section.count}
            </span>
          </a>
        ))
      }
    </div>

    <div class="space-y-24">
      <!-- Papers -->
      <section id="papers" class="scroll-mt-24">
        <div class="flex items-center gap-3 mb-8">
          <BookOpen className="w-8 h-8 text-blue-600" />
          <h2
            class="text-3xl font-bold text-gray-900"
            data-i18n-key="achievements.papers"
          >
            Published Papers
          </h2>
        </div>
        <div class="grid gap-6">
          {papers.map((paper) => <PublicationItem entry={paper} />)}
          {
            papers.length === 0 && (
              <p
                class="text-gray-500 italic"
                data-i18n-key="achievements.noPapers"
              >
                No papers listed yet.
              </p>
            )
          }
        </div>
      </section>

      <!-- Newspapers -->
      <section id="newspapers" class="scroll-mt-24">
        <div class="flex items-center gap-3 mb-8">
          <Newspaper className="w-8 h-8 text-blue-600" />
          <h2
            class="text-3xl font-bold text-gray-900"
            data-i18n-key="achievements.newspapers"
          >
            Newspaper Articles
          </h2>
        </div>

        <div class="grid gap-6">
          {newspapers.map((paper) => <PublicationItem entry={paper} />)}
          {
            newspapers.length === 0 && (
              <p
                class="text-gray-500 italic"
                data-i18n-key="achievements.noNewspapers"
              >
                No newspaper articles listed yet.
              </p>
            )
          }
        </div>
      </section>

      <!-- Section removed until further notice -->
      <!-- Softwares -->
      <!-- <section id="softwares" class="scroll-mt-24">
        <div class="flex items-center gap-3 mb-8">
          <FileCode className="w-8 h-8 text-blue-600" />
          <h2
            class="text-3xl font-bold text-gray-900"
            data-i18n-key="achievements.softwares"
          >
            Software Copyrights (Placeholder)
          </h2>
        </div>
        <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
          {
            softwares.map((software) => (
              <div class="bg-white p-6 rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow">
                <div class="flex items-start gap-4 mb-4">
                  <div class="p-3 bg-blue-50 text-blue-600 rounded-lg shrink-0">
                    <FileCode className="w-6 h-6" />
                  </div>
                  <h3
                    class="text-lg font-bold text-gray-900 line-clamp-2 pt-1"
                    title={software.data.title}
                  >
                    {software.data.title}
                  </h3>
                </div>
                <div class="space-y-2 text-sm text-gray-600">
                  <div>
                    <span
                      class="font-medium text-gray-900"
                      data-i18n-key="achievements.developers"
                    >
                      Developers:
                    </span>{" "}
                    {software.data.developers.join(", ")}
                  </div>
                  <div class="flex items-center justify-between pt-2 border-t border-gray-50">
                    <span class="font-mono bg-gray-50 px-2 py-0.5 rounded border border-gray-200 text-xs">
                      {software.data.number}
                    </span>
                    <time class="text-gray-400">
                      {software.data.date.toLocaleDateString()}
                    </time>
                  </div>
                </div>
              </div>
            ))
          }
          {
            softwares.length === 0 && (
              <p
                class="text-gray-500 italic"
                data-i18n-key="achievements.noSoftwares"
              >
                No software copyrights listed yet.
              </p>
            )
          }
        </div>
      </section> -->

      <!-- Presentations -->
      <section id="presentations" class="scroll-mt-24">
        <div class="flex items-center gap-3 mb-8">
          <Presentation className="w-8 h-8 text-blue-600" />
          <h2
            class="text-3xl font-bold text-gray-900"
            data-i18n-key="achievements.presentations"
          >
            Conferences, Presentations & Events
          </h2>
        </div>

        <!-- Presentations Group -->
        <div class="mb-8 relative group/slider">
          <!-- Left / Right buttons -->
          <button
            id="pres-left-btn"
            aria-label="Scroll left"
            type="button"
            onclick="scrollContainer('presentations-scroll', -1)"
            class="absolute -left-4 top-1/2 -translate-y-1/2 z-20 bg-white border border-gray-200 rounded-full p-2 shadow-sm hover:shadow-md hidden cursor-pointer text-gray-600 hover:text-blue-600 transition-all"
          >
            <ArrowRight className="w-5 h-5 rotate-180" />
          </button>
          <button
            id="pres-right-btn"
            aria-label="Scroll right"
            type="button"
            onclick="scrollContainer('presentations-scroll', 1)"
            class="absolute -right-4 top-1/2 -translate-y-1/2 z-20 bg-white border border-gray-200 rounded-full p-2 shadow-sm hover:shadow-md hidden cursor-pointer text-gray-600 hover:text-blue-600 transition-all"
          >
            <ArrowRight className="w-5 h-5" />
          </button>

          <div
            id="presentations-scroll"
            class="overflow-x-auto pb-4 -mx-4 px-4 sm:mx-0 sm:px-0 flex gap-4 scroll-smooth hide-scrollbar"
          >
            <!-- Items -->
            {
              presentations.map((item) => (
                <div class="flex-shrink-0 w-[400px] sm:w-[420px]">
                  <PresentationCard entry={item} />
                </div>
              ))
            }
          </div>
        </div>
        {
          allPresentations.length === 0 && (
            <p
              class="text-gray-500 italic"
              data-i18n-key="achievements.noPresentations"
            >
              No presentations listed yet.
            </p>
          )
        }
      </section>
    </div>
  </div>

  <!-- Scroll Script -->
  <script is:inline>
    function scrollContainer(id, direction) {
      const container = document.getElementById(id);
      if (!container) return;
      const scrollAmount = container.clientWidth * 0.75 * direction;
      container.scrollBy({ left: scrollAmount, behavior: "smooth" });
    }

    function updateArrows(containerId, leftBtnId, rightBtnId) {
      const container = document.getElementById(containerId);
      const leftBtn = document.getElementById(leftBtnId);
      const rightBtn = document.getElementById(rightBtnId);

      if (!container || !leftBtn || !rightBtn) return;

      leftBtn.style.display =
        container.scrollLeft > 10 ? "inline-flex" : "none";

      // Check if scrolled to end
      const isAtEnd =
        Math.ceil(container.scrollLeft + container.clientWidth) >=
        container.scrollWidth - 10;
      rightBtn.style.display = isAtEnd ? "none" : "inline-flex";
    }

    function setupScrollListener(containerId, leftBtnId, rightBtnId) {
      const container = document.getElementById(containerId);
      if (container) {
        // Initial check
        updateArrows(containerId, leftBtnId, rightBtnId);
        // Scroll listener
        container.addEventListener("scroll", () =>
          updateArrows(containerId, leftBtnId, rightBtnId),
        );
        // Resize listener
        window.addEventListener("resize", () =>
          updateArrows(containerId, leftBtnId, rightBtnId),
        );
      }
    }

    if (typeof window !== "undefined") {
      window.addEventListener("load", () => {
        setupScrollListener(
          "presentations-scroll",
          "pres-left-btn",
          "pres-right-btn",
        );
        setupScrollListener(
          "conferences-scroll",
          "conf-left-btn",
          "conf-right-btn",
        );
      });
    }
  </script>
</Layout>
